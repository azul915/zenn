---
title: "CircleCIã§CloudFunctionsã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹" # è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«
emoji: "ğŸ”¨" # ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹çµµæ–‡å­—ï¼ˆ1æ–‡å­—ã ã‘ï¼‰
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹
topics: ["circleci", "cloudfunctions", "gcp"] # ã‚¿ã‚°ã€‚["markdown", "rust", "aws"]ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹
published: true # å…¬é–‹è¨­å®šï¼ˆfalseã«ã™ã‚‹ã¨ä¸‹æ›¸ãï¼‰
---

# ã‚´ãƒ¼ãƒ«
GitHubãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹CloudFunctionsã§å‹•ã‹ã™ã‚³ãƒ¼ãƒ‰(python)ã«ã¤ã„ã¦ã€
masterã«ãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã¨ãã«ã€CircleCIã®Jobã¨ã—ã¦ã€CloudFunctionsã«zipã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

# TL;DR
1. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
2. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹
3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã™ã‚‹
4. CircleCIã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
5. ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã™ã‚‹
- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã«é–¢ã—ã¦ã¯ã€`gcloud`ã‚„Terraformã§ã‚‚ã§ãã¾ã™ãŒã€ä»Šå›ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚„ã‚Šã¾ã™ã€‚
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯äºˆã‚ä½œæˆã—ã¦ã€é¸æŠã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æã§ã™ã€‚
1. **ID** > **ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ** ã‚’é¸æŠã™ã‚‹
![](/images/7154cf48a49f28/select-service-account.png)
2. **ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ** ã‚’é¸æŠã™ã‚‹
![](/images/7154cf48a49f28/select-making-seviceaccount.png)
3. **ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå** ã‚’å…¥åŠ›ã—ã€**ä½œæˆ** ã‚’æŠ¼ã™
![](/images/7154cf48a49f28/input-serviceaccount-name.png)
4. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ä»˜ä¸ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã‚’é¸æŠã™ã‚‹
	- CloudFunctionsé–‹ç™ºè€…
	- ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼
![](/images/7154cf48a49f28/select-serviceaccount-role.0.png)
![](/images/7154cf48a49f28/select-serviceaccount-role.1.png)
5. å®Œäº†(ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã—ãªã„)
![](/images/7154cf48a49f28/push-complete-button.png)

# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’å–å¾—ã™ã‚‹
1. ä½œæˆã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã¤ã„ã¦ã€**éµã‚’ä½œæˆ**ã™ã‚‹
![](/images/7154cf48a49f28/get-service-account-key.png)

2. (ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸéµã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®CloudFunctionsã®æ“ä½œãŒã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹)
```bash
# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆã«ã™ã‚‹
~$ gcloud auth activate-service-account --key-file $HOME/Downloads/project-abcdefgh.json
Activated service account credentials for: [circleci-to-gcf@project.iam.gserviceaccount.com]

# ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®zip
~$ ls $HOME/Desktop/gcf/
sample.zip

# ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è©¦è¡Œã™ã‚‹ã€‚
# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§CloudFunctionsã«deployæ“ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚Œã°è‰¯ã„ã®ã§403ç­‰ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã«ã‚ˆã‚‹å¤±æ•—ã§ãªã‘ã‚Œã°ã€ã“ã“ã§ã®ç›®çš„ã¯æœãŸã—ãŸã¨ã¿ãªã—ã¦ã‚ˆã„
~$ gcloud functions deploy sample --trigger-http --runtime=python38 --source=$HOME/Desktop/gcf/
WARNING: Function created with limited-access IAM policy. To enable unauthorized access consider "gcloud alpha functions add-iam-policy-binding sample --member=allUsers --role=roles/cloudfunctions.invoker"
Deploying function (may take a while - up to 2 minutes)...WARNING: Setting IAM policy failed, try "gcloud alpha functions add-iam-policy-binding sample --member=allUsers --role=roles/cloudfunctions.invoker"
```

# ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã™ã‚‹
1. CircleCIã‹ã‚‰å¯¾è±¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®**Project Settings** ã‚’é¸æŠã™ã‚‹
![](/images/7154cf48a49f28/select-project-settings-on-circleci.png)

2. **Add Environment Variable** ã‚’é¸æŠã™ã‚‹
![](/images/7154cf48a49f28/add-environment-variable-on-circleci.png)

3. ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼(jsonãƒ•ã‚¡ã‚¤ãƒ«)ã‚’base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã™ã‚‹

	```bash
	~$ cat ~/Downloads/project-abcdefgh.json | base64
	hogefuga
	```

4. base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã™ã‚‹
![](/images/7154cf48a49f28/input-base64-encode-as-env-variable-on-circleci.png)


# CircleCIã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹
- yamlã§ã¯ãªã**yml**ã¨ã™ã‚‹ã“ã¨

```yaml
# .circleci/config.yml
version: 2.1

jobs:
  deploy:
    docker:
    - image: google/cloud-sdk:alpine
    environment:
      PROJECT: ""
      FUNCTION_NAME: ""
      ENTRY_POINT: ""
      RUNTIME: "python37"
      TRIGGER_EVENT: "providers/cloud.pubsub/eventTypes/topic.publish"
      TRIGGER_RESOURCE: ""
      REGION: "us-central1"
      MEMORY: "256MB"
      TIMEOUT: "60s"
    steps:
    - checkout
    - run:
        name: Prepare
        command: |
          apk --no-cache add zip
    - run:
        name: Zip scripts
        command: |
          zip functions -r ./app
    - run:
        name: Authorize gcloud
        command: |
          echo $SERVICE_ACCOUNT_KEY | base64 -d | \
            gcloud auth activate-service-account --key-file=-
    - run:
        name: Deploy to Google Cloud Functions
        command: |
          echo $ENV_FILE | base64 -d > .env.yaml
          gcloud functions deploy $FUNCTION_NAME \
            --entry-point $ENTRY_POINT \
            --runtime $RUNTIME \
            --trigger-event $TRIGGER_EVENT \
            --trigger-resource $TRIGGER_RESOURCE \
            --source ./app/ \
            --env-vars-file .env.yaml \
            --project $PROJECT \
            --region $REGION \
            --memory $MEMORY \
            --timeout $TIMEOUT
workflows:
  version: 2
  build-test-and-deploy:
    jobs:
      - deploy:
        filters:
          branches:
            only:
              - master
```

# ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
- config.ymlã‚’ã‚³ãƒŸãƒƒãƒˆã«å«ã‚ã¦ã€`git push origin master` ã™ã‚‹ã¨ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå§‹ã¾ã‚‹
- æˆåŠŸä¾‹
![](/images/7154cf48a49f28/deploy-on-circleci.png)


